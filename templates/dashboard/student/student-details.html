{% extends 'dashboard/base.html' %}
{% load static %}
{% block content%}


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>


<style>
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }
    
    .accordion-body .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .table-scroll-container {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 1rem;
        border: 1px solid rgba(0,0,0,.125);
        border-radius: 0.25rem;
    }
</style>

<div class="page-wrapper">
    <div class="content content-two">
        <div class="row">

            <div class="col-md-12">
                <div class="d-md-flex d-block align-items-center justify-content-between mb-3">
                    <div class="my-auto mb-2">
                        <h3 class="page-title mb-1">Student Details</h3>
                        <nav aria-label="breadcrumbs">
                            <ol class="custom-breadcrumb">
                                <li class="custom-breadcrumb-item"><a href="{% url 'dashboard-home' %}">Dashboard</a></li>
                                {% if request.GET.from_batch %}
                                    <li class="custom-breadcrumb-item"><a href="{% url 'dashboard-batch' %}">Batch</a></li>
                                    <li class="custom-breadcrumb-item"><a href="{% url 'dashboard-batch-students' batch_id=request.GET.from_batch %}">Students</a></li>
                                    <li class="custom-breadcrumb-item">View Details</li>
                                {% else %}
                                    <li class="custom-breadcrumb-item"><a href="{% url 'dashboard-customer' %}">Student</a></li>
                                    <li class="custom-breadcrumb-item">View Details</li>
                                {% endif %}
                            </ol>
                        </nav>
                    </div>
                    <div class="d-flex my-xl-auto right-content align-items-center  flex-wrap">
                        <a href="#" class="btn btn-light me-2 mb-2" data-bs-toggle="modal"
                            data-bs-target="#login_detail"><i class="bi bi-lock me-2"></i>
                                Login Details</a>
                                <!-- <a href="#" class="btn btn-light me-2 mb-2" data-bs-toggle="modal" data-bs-target="#addsubscription">
                                    <i class="bi bi-people me-2"></i> Add Subscription
                                </a> -->
                        
                        {% if customer.is_suspended %}
                        <a href="#" class="btn btn-success me-2 mb-2" data-bs-toggle="modal"
                            data-bs-target="#unsuspend-modal"><i class="bi bi-person-check me-2"></i>
                                Unsuspend Student</a>
                        {% else %}
                        <a href="#" class="btn btn-warning me-2 mb-2" data-bs-toggle="modal"
                            data-bs-target="#suspend-modal"><i class="bi bi-person-lock me-2"></i>
                                Suspend Student</a>
                        {% endif %}
                                
                        <a href="{% url 'dashboard-customer-update' pk=customer.id %}"
                            class="btn btn-primary d-flex align-items-center mb-2"><i class="bi bi-pencil-fill me-2"></i>
                            Edit Student</a>
                    </div>
                </div>
            </div>

        </div>
        <div class="row">

            <div class="col-xxl-3 col-xl-4 theiaStickySidebar">
                <div class="card border-white">
                        <a href="#" class="btn btn-light me-2 mb-2" data-bs-toggle="modal"
                            data-bs-target="#admission_detail"><i class="bi bi-person-plus"></i>

                            Add Admission 
                        </a>

                    <div class="card-header">
                        <div class="d-flex align-items-center flex-wrap row-gap-3">
                            <div
                                class="d-flex align-items-center justify-content-center avatar avatar-xxl border border-dashed me-2 flex-shrink-0 text-dark frames">
                                {% if customer.image %}
                                <img src="{{customer.image.url}}" class="img-fluid" alt="img">
                                {% else %}
                                <i class="bi bi-person-circle fs-3 text-dark"></i>

                                {% endif %}
                            </div>
                            <div class="overflow-hidden">
                                <span class="badge badge-soft-success d-inline-flex align-items-center mb-1"><i
                                        class="ti ti-circle-filled fs-5 me-1"></i>Active</span>
                                <h5 class="mb-1 text-truncate">{{customer.name}}</h5>
                                <p class="text-primary">{{customer.id}}</p>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <h5 class="mb-3">Basic Information</h5>
                        <dl class="row mb-0">
                            <dt class="col-6 fw-medium text-dark mb-3">ID</dt>
                            <dd class="col-6 mb-3">{{customer.id}}</dd>
                            <dt class="col-6 fw-medium text-dark mb-3">Name</dt>
                            <dd class="col-6 mb-3">{{customer.name}}</dd>
                            <dt class="col-6 fw-medium text-dark mb-3">Email</dt>
                            <dd class="col-6 mb-3">{{customer.email}}</dd>
                            <dt class="col-6 fw-medium text-dark mb-3">District</dt>
                            <dd class="col-6 mb-3">{{customer.get_district_display }}</dd>
                            <dt class="col-6 fw-medium text-dark mb-3">Phone Number</dt>
                            <dd class="col-6 mb-3">{{customer.phone_number}}</dd>

                            <!-- <dt class="col-6 fw-medium text-dark mb-3">Course Purchased</dt>
                            <dd class="col-6 mb-3">
                                {% if courses %}
                                {% for course in courses %}
                                <span class="badge badge-light text-dark me-2">{{ course.course_name }}</span>
                                {% endfor %}
                                {% else %}
                                <span class="badge badge-light text-dark">No courses purchased</span>
                                {% endif %}
                            </dd> -->
                        </dl>
                        <!-- <a href="#" data-bs-toggle="modal" data-bs-target="#add_fees_collect"
                            class="btn btn-primary btn-sm w-100">Add Fees</a> -->
                    </div>

                </div>

                <div class="card border-white">
                    <div class="card-body">
                        <h5 class="mb-3">Primary Contact Info</h5>
                        <div class="d-flex align-items-center mb-3">
                            <span class="avatar avatar-md bg-light-300 rounded me-2 flex-shrink-0 text-default"><i
                                    class="bi bi-telephone"></i></span>
                            <div>
                                <span class="text-dark fw-medium mb-1">Phone Number</span>
                                <p class="text-truncate" title="{{ customer.phone_number }}">{{customer.phone_number}}</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="avatar avatar-md bg-light-300 rounded me-2 flex-shrink-0 text-default"><i
                                    class="bi bi-envelope"></i>
                            </span>
                            <div class="overflow-hidden">
                                <span class="text-dark fw-medium mb-1">Email Address</span>
                                <p class="text-truncate" title="{{ customer.email }}">{{customer.email}}</p>
                            </div>
                        </div>
                    </div>
                </div>





                <div class="card border-white">
                    <div class="card-body">
                        <h5 class="mb-3">Purchased Courses</h5>
                
                        <!-- Display Batch Details -->
                        <ul class="list-unstyled">
                            {% for batch in batch_details %}
                                <li class="mb-3 border-bottom pb-3">
                                    <div class="d-flex align-items-start">
                                        <span class="avatar avatar-sm bg-light-300 rounded me-3 flex-shrink-0 text-default">
                                            <i class="bi bi-file-earmark-text fs-5"></i>

                                        </span>
                                        <div>
                                            <strong>Course:</strong> {{ batch.course_name }} <br>
                                            <strong>
                                                <i class="bi bi-calendar me-1"></i> Start Date:
                                            </strong>
                                            {{ batch.start_date|date:"d-m-Y"}} <br>
                                            <strong>
                                                <i class="bi bi-calendar-x me-1"></i> End Date:
                                            </strong>
                                            {{ batch.expiry_date|date:"d-m-Y" }} <br>
                                            <strong>
                                                <i class="bi bi-currency-rupee me-1"></i>
                                                    Price:
                                            </strong>
                                            {{ batch.price|floatformat:2 }} <br>
                                            {% if batch.subscription_id %}
                                            <a href="{% url 'dashboard-subscription-detail' pk=batch.subscription_id %}" class="btn btn-sm btn-primary mt-2">
                                                <i class="bi bi-receipt me-1"></i> View Subscription Details
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </li>
                            {% empty %}
                                <li>No batches found.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                
                

            </div>

            <div class="col-xxl-9 col-xl-8">
                <div class="row">
                    <ul class="nav nav-tabs nav-tabs-bottom mb-4">
                        <!-- <li>
                            <a href="#" class="nav-link active" data-target="studentDetails">Student Details</a>
                        </li> -->
                        <li>
                            <a href="#" class="nav-link active" data-target="examProgressResults">Exam Results</a>
                        </li>
                        <li>
                            <a href="#" class="nav-link " data-target="talenhuntResults">TalentHunt Results</a>
                        </li>
                    </ul>

                    <div id="studentDetails" class="tab-content active">

                            </div>
                            <div id="talenhuntResults" class="tab-content ">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header d-flex align-items-center justify-content-between flex-wrap pb-0">
                                            <h4 class="mb-3">TalentHunt Progress & Results</h4>
                                            <!-- View Progress Report Button -->  
                                            <div class="d-flex align-items-center flex-wrap">
                                                <div class="me-2">
                                                    <a href="{% url 'dashboard-student-talenthunt-report' pk=customer.id %}" class="btn btn-primary d-flex align-items-center">
                                                        <i class="bi bi-graph-up me-2"></i> View Progress Report
                                                    </a>
                                                </div>
                                                <div class="dropdown me-2">
                                                    <button class="btn btn-success dropdown-toggle d-flex align-items-center" type="button" id="exportTalentHuntDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="bi bi-file-earmark-arrow-down me-2"></i> Export Results
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="exportTalentHuntDropdown">
                                                        <li><a class="dropdown-item d-flex align-items-center" href="{% url 'dashboard-export-talenthunt-results' pk=customer.id %}?format=excel">
                                                            <i class="bi bi-file-earmark-excel me-2"></i> CSV
                                                        </a></li>
                                                        <li><a class="dropdown-item d-flex align-items-center" href="{% url 'dashboard-export-talenthunt-results' pk=customer.id %}?format=pdf">
                                                            <i class="bi bi-file-earmark-pdf me-2"></i> PDF
                                                        </a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            {% if progress_data %}
                                            <div class="accordions-items-separate" id="accordionExample">
                                                {% for progress in progress_data %}
                                                    <div class="accordion-item">
                                                        <h2 class="accordion-header">
                                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}"
                                                                aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
                                                                <span class="avatar avatar-sm bg-success me-2"><i class="bi bi-check2-all"></i></span>
                                                                {% if progress.level.talenthuntsubject.talentHunt.title %}
                                                                    {{ progress.level.talenthuntsubject.talentHunt.title }}
                                                                {% else %}
                                                                    {{ progress.level.title }}
                                                                {% endif %}
                                                            </button>
                                                        </h2>
                                                        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                                                            <div class="accordion-body">
                                                                <!-- Original Table Section -->
                                                                <div class="table-responsive">
                                                                    <table class="table">
                                                                        <thead class="thead-light">
                                                                            <tr>
                                                                                <th>Subject</th>
                                                                                <th>Total Questions</th>
                                                                                <th>Correct Answers</th>
                                                                                <th>Wrong Answers</th>
                                                                                <th>Unanswered</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            <tr>
                                                                                <td>{{ progress.level.title }}</td>
                                                                                <td>{{ progress.total_questions }}</td>
                                                                                <td>{{ progress.correct_answers|length }}</td>
                                                                                <td>{{ progress.wrong_answers|length }}</td>
                                                                                <td>{{ progress.unanswered_questions|length }}</td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                            
                                                                <!-- Expandable Detailed Analysis Section -->
                                                                <div class="accordion mt-4" id="expandableResults">
                                                                    <div class="accordion-item">
                                                                        <h2 class="accordion-header" id="expandableHeading{{ forloop.counter }}">
                                                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                                                data-bs-target="#expandableSection{{ forloop.counter }}" aria-expanded="false"
                                                                                aria-controls="expandableSection{{ forloop.counter }}">
                                                                                View Detailed Analysis
                                                                            </button>
                                                                        </h2>
                                                                        <div id="expandableSection{{ forloop.counter }}" class="accordion-collapse collapse"
                                                                            aria-labelledby="expandableHeading{{ forloop.counter }}" data-bs-parent="#expandableResults">
                                                                            <div class="accordion-body">
                                                                                <div class="accordion" id="nestedAccordion{{ forloop.counter }}">
                                                                                    <!-- Correct Answers Table -->
                                                                                    <div class="accordion-item">
                                                                                        <h2 class="accordion-header" id="rightHeading{{ forloop.counter }}">
                                                                                            <button class="accordion-button collapsed" type="button"
                                                                                                data-bs-toggle="collapse" data-bs-target="#rightDetails{{ forloop.counter }}"
                                                                                                aria-expanded="false" aria-controls="rightDetails{{ forloop.counter }}">
                                                                                                Correct Answers
                                                                                            </button>
                                                                                        </h2>
                                                                                        <div id="rightDetails{{ forloop.counter }}" class="accordion-collapse collapse"
                                                                                            aria-labelledby="rightHeading{{ forloop.counter }}" data-bs-parent="#nestedAccordion{{ forloop.counter }}">
                                                                                            <div class="accordion-body">
                                                                                                <div class="table-responsive">
                                                                                                    <table class="table">
                                                                                                        <thead>
                                                                                                            <tr>
                                                                                                                <th>Question</th>
                                                                                                                <th>Your Answer</th>
                                                                                                                <th>Correct Answer</th>
                                                                                                            </tr>
                                                                                                        </thead>
                                                                                                        <tbody>
                                                                                                            {% for correct in progress.correct_answers %}
                                                                                                                <tr>
                                                                                                                    <td>{{ correct.question }}</td>
                                                                                                                    <td>{{ correct.your_answer }}</td>
                                                                                                                    <td>{{ correct.correct_answer.0.text  }}</td>
                                                                                                                </tr>
                                                                                                            {% endfor %}
                                                                                                        </tbody>
                                                                                                    </table>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                            
                                                                                    <!-- Wrong Answers Table -->
                                                                                    <div class="accordion-item">
                                                                                        <h2 class="accordion-header" id="wrongHeading{{ forloop.counter }}">
                                                                                            <button class="accordion-button collapsed" type="button"
                                                                                                data-bs-toggle="collapse" data-bs-target="#wrongDetails{{ forloop.counter }}"
                                                                                                aria-expanded="false" aria-controls="wrongDetails{{ forloop.counter }}">
                                                                                                Wrong Answers
                                                                                            </button>
                                                                                        </h2>
                                                                                        <div id="wrongDetails{{ forloop.counter }}" class="accordion-collapse collapse"
                                                                                            aria-labelledby="wrongHeading{{ forloop.counter }}" data-bs-parent="#nestedAccordion{{ forloop.counter }}">
                                                                                            <div class="accordion-body">
                                                                                                <div class="table-responsive">
                                                                                                    {% if progress.wrong_answers %}
                                                                                                        <table class="table">
                                                                                                            <thead>
                                                                                                                <tr>
                                                                                                                    <th>Question</th>
                                                                                                                    <th>Your Answer</th>
                                                                                                                    <th>Correct Answer</th>
                                                                                                                </tr>
                                                                                                            </thead>
                                                                                                            <tbody>
                                                                                                                {% for wrong in progress.wrong_answers %}
                                                                                                                    <tr>
                                                                                                                        <td>{{ wrong.question }}</td>
                                                                                                                        <td>{{ wrong.your_answer }}</td>
                                                                                                                        <td>{{ wrong.correct_answer.0.text  }}</td>
                                                                                                                    </tr>
                                                                                                                {% endfor %}
                                                                                                            </tbody>
                                                                                                        </table>
                                                                                                    {% else %}
                                                                                                        <div class="text-center">
                                                                                                            <p class="text-muted">No wrong answers.</p>
                                                                                                        </div>
                                                                                                    {% endif %}
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    
                            
                                                                                    <!-- Unanswered Questions Table -->
                                                                                    <div class="accordion-item">
                                                                                        <h2 class="accordion-header" id="unansweredHeading{{ forloop.counter }}">
                                                                                            <button class="accordion-button collapsed" type="button"
                                                                                                data-bs-toggle="collapse" data-bs-target="#unansweredDetails{{ forloop.counter }}"
                                                                                                aria-expanded="false" aria-controls="unansweredDetails{{ forloop.counter }}">
                                                                                                Unanswered Questions
                                                                                            </button>
                                                                                        </h2>
                                                                                        <div id="unansweredDetails{{ forloop.counter }}" class="accordion-collapse collapse"
                                                                                        aria-labelledby="unansweredHeading{{ forloop.counter }}" data-bs-parent="#nestedAccordion{{ forloop.counter }}">
                                                                                        <div class="accordion-body">
                                                                                            <div class="table-responsive">
                                                                                                {% if progress.unanswered_questions %}

                                                                                                    <table class="table">
                                                                                                        <thead>
                                                                                                            <tr>
                                                                                                                <th>Question</th>
                                                                                                                <!-- <th>Correct Answer</th> -->
                                                                                                            </tr>
                                                                                                        </thead>
                                                                                                        <tbody>
                                                                                                            {% for unanswered in progress.unanswered_questions %}

                                                                                                                <tr>
                                                                                                                    <td>{{ unanswered.question }}</td>
                                                                                                                    <!-- <td>{{ unanswered.your_answer }}</td>
                                                                                                                    <td>{{ unanswered.correct_answer.0.text|default:"N/A" }}</td> -->
                                                                                                                </tr>
                                                                                                            {% endfor %}
                                                                                                        </tbody>
                                                                                                    </table>
                                                                                                    {% else %}
                                                                                                    <div class="text-center">
                                                                                                        <p class="text-muted">No unanswered questions.</p>
                                                                                                    </div>
                                                                                                {% endif %}
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    </div>
                                                                                    
                                                                                </div> <!-- End of Nested Accordion -->
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div> <!-- End of Expandable Detailed Analysis Section -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <div class="text-center">
                                                <p class="text-muted">No progression report for TalentHunt.</p>
                                            </div>
                                        {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>



                            
                            

                            <div id="examProgressResults" class="tab-content active">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header d-flex align-items-center justify-content-between flex-wrap pb-0">
                                            <h4 class="mb-3">Exam Progress & Results</h4>
                                            <div class="d-flex align-items-center flex-wrap">
                                                <!-- Exam Type Filter -->
                                                <div class="me-3">
                                                    <form id="examTypeFilterForm" method="get" class="d-flex align-items-center">
                                                        <label for="examTypeFilter" class="me-2 align-self-center">Filter: </label>
                                                        <select id="examTypeFilter" name="exam_type" class="form-select form-select-sm" onchange="this.form.submit()">
                                                            <option value="" {% if not selected_exam_type %}selected{% endif %}>All Types</option>
                                                            {% for type_value, type_label in exam_types %}
                                                                <option value="{{ type_value }}" {% if selected_exam_type == type_value %}selected{% endif %}>{{ type_label }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </form>
                                                </div>
                                                <!-- View Progress Report Button -->  
                                                <div class="me-2">
                                                    <a href="{% url 'dashboard-student-progress-report' pk=customer.id %}{% if selected_exam_type %}?exam_type={{ selected_exam_type }}{% endif %}" class="btn btn-primary d-flex align-items-center">
                                                        <i class="bi bi-graph-up me-2"></i> View Progress Report
                                                    </a>
                                                </div>
                                                <!-- Export Dropdown -->  
                                                <div class="dropdown me-2">
                                                    <button class="btn btn-success dropdown-toggle d-flex align-items-center" type="button" id="exportExamDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="bi bi-file-earmark-arrow-down me-2"></i> Export Results
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="exportExamDropdown">
                                                        <li><a class="dropdown-item d-flex align-items-center" href="{% url 'dashboard-export-exam-results' pk=customer.id %}?format=excel{% if selected_exam_type %}&exam_type={{ selected_exam_type }}{% endif %}">
                                                            <i class="bi bi-file-earmark-excel me-2"></i> CSV
                                                        </a></li>
                                                        <li><a class="dropdown-item d-flex align-items-center" href="{% url 'dashboard-export-exam-results' pk=customer.id %}?format=pdf{% if selected_exam_type %}&exam_type={{ selected_exam_type }}{% endif %}">
                                                            <i class="bi bi-file-earmark-pdf me-2"></i> PDF
                                                        </a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            {% if exam_progress_data %}
                                            <div class="accordions-items-separate" id="accordionExampleExam">
                                                {% for progress in exam_progress_data %}
                                                    <div class="accordion-item">
                                                        <h2 class="accordion-header">
                                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExam{{ forloop.counter }}"
                                                                aria-expanded="false" aria-controls="collapseExam{{ forloop.counter }}">
                                                                <span class="avatar avatar-sm bg-success me-2"><i class="bi bi-check2-all"></i></span>
                                                                {% if progress.exam.title %}
                                                                    {{ progress.exam.title }}
                                                                {% else %}
                                                                    {{ progress.exam.title }}
                                                                {% endif %}
                                                            </button>
                                                        </h2>
                                                        <div id="collapseExam{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionExampleExam">
                                                            <div class="accordion-body">
                                                                <!-- Original Table Section -->
                                                                <div class="table-responsive">
                                                                    <table class="table">
                                                                        <thead class="thead-light">
                                                                            <tr>
                                                                                <th>Subject</th>
                                                                                <th>Total Questions</th>
                                                                                <th>Correct Answers</th>
                                                                                <th>Wrong Answers</th>
                                                                                <th>Unanswered</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            <tr>
                                                                                <td>{{ progress.exam.title }}</td>
                                                                                <td>{{ progress.total_questions }}</td>
                                                                                <td>{{ progress.correct_answers|length }}</td>
                                                                                <td>{{ progress.wrong_answers|length }}</td>
                                                                                <td>{{ progress.unanswered_questions|length }}</td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                            
                                                                <!-- Expandable Detailed Analysis Section -->
                                                                <div class="accordion mt-4" id="expandableResultsExam{{ forloop.counter }}">
                                                                    <div class="accordion-item">
                                                                        <h2 class="accordion-header" id="expandableHeadingExam{{ forloop.counter }}">
                                                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                                                data-bs-target="#expandableSectionExam{{ forloop.counter }}" aria-expanded="false"
                                                                                aria-controls="expandableSectionExam{{ forloop.counter }}">
                                                                                View Detailed Analysis
                                                                            </button>
                                                                        </h2>
                                                                        <div id="expandableSectionExam{{ forloop.counter }}" class="accordion-collapse collapse"
                                                                            aria-labelledby="expandableHeadingExam{{ forloop.counter }}" data-bs-parent="#expandableResultsExam{{ forloop.counter }}">
                                                                            <div class="accordion-body">
                                                                                <div class="accordion" id="nestedAccordionExam{{ forloop.counter }}">
                                                                                    <!-- Correct Answers Table -->
                                                                                    <div class="accordion-item">
                                                                                        <h2 class="accordion-header" id="rightHeadingExam{{ forloop.counter }}">
                                                                                            <button class="accordion-button collapsed" type="button"
                                                                                                data-bs-toggle="collapse" data-bs-target="#rightDetailsExam{{ forloop.counter }}"
                                                                                                aria-expanded="false" aria-controls="rightDetailsExam{{ forloop.counter }}">
                                                                                                Correct Answers
                                                                                            </button>
                                                                                        </h2>
                                                                                        <div id="rightDetailsExam{{ forloop.counter }}" class="accordion-collapse collapse"
                                                                                            aria-labelledby="rightHeadingExam{{ forloop.counter }}" data-bs-parent="#nestedAccordionExam{{ forloop.counter }}">
                                                                                            <div class="accordion-body">
                                                                                                <div class="table-responsive">
                                                                                                    <table class="table">
                                                                                                        <thead>
                                                                                                            <tr>
                                                                                                                <th>Question</th>
                                                                                                                <th>Your Answer</th>
                                                                                                                <th>Correct Answer</th>
                                                                                                            </tr>
                                                                                                        </thead>
                                                                                                        <tbody>
                                                                                                            {% for correct in progress.correct_answers %}
                                                                                                                <tr>
                                                                                                                    <td>{{ correct.question }}</td>
                                                                                                                    <td>{{ correct.your_answer }}</td>
                                                                                                                    <td>{{ correct.correct_answer.0.text }}</td>
                                                                                                                </tr>
                                                                                                            {% endfor %}
                                                                                                        </tbody>
                                                                                                    </table>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                            
                                                                                    <!-- Wrong Answers Table -->
                                                                                    <div class="accordion-item">
                                                                                        <h2 class="accordion-header" id="wrongHeadingExam{{ forloop.counter }}">
                                                                                            <button class="accordion-button collapsed" type="button"
                                                                                                data-bs-toggle="collapse" data-bs-target="#wrongDetailsExam{{ forloop.counter }}"
                                                                                                aria-expanded="false" aria-controls="wrongDetailsExam{{ forloop.counter }}">
                                                                                                Wrong Answers
                                                                                            </button>
                                                                                        </h2>
                                                                                        <div id="wrongDetailsExam{{ forloop.counter }}" class="accordion-collapse collapse"
                                                                                            aria-labelledby="wrongHeadingExam{{ forloop.counter }}" data-bs-parent="#nestedAccordionExam{{ forloop.counter }}">
                                                                                            <div class="accordion-body">
                                                                                                <div class="table-responsive">
                                                                                                    {% if progress.wrong_answers %}
                                                                                                        <table class="table">
                                                                                                            <thead>
                                                                                                                <tr>
                                                                                                                    <th>Question</th>
                                                                                                                    <th>Your Answer</th>
                                                                                                                    <th>Correct Answer</th>
                                                                                                                </tr>
                                                                                                            </thead>
                                                                                                            <tbody>
                                                                                                                {% for wrong in progress.wrong_answers %}
                                                                                                                    <tr>
                                                                                                                        <td>{{ wrong.question }}</td>
                                                                                                                        <td>{{ wrong.your_answer }}</td>
                                                                                                                        <td>{{ wrong.correct_answer.0.text }}</td>
                                                                                                                    </tr>
                                                                                                                {% endfor %}
                                                                                                            </tbody>
                                                                                                        </table>
                                                                                                    {% else %}
                                                                                                        <div class="text-center">
                                                                                                            <p class="text-muted">No wrong answers.</p>
                                                                                                        </div>
                                                                                                    {% endif %}
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                            
                                                                                    <!-- Unanswered Questions Table -->
                                                                                    <div class="accordion-item">
                                                                                        <h2 class="accordion-header" id="unansweredHeadingExam{{ forloop.counter }}">
                                                                                            <button class="accordion-button collapsed" type="button"
                                                                                                data-bs-toggle="collapse" data-bs-target="#unansweredDetailsExam{{ forloop.counter }}"
                                                                                                aria-expanded="false" aria-controls="unansweredDetailsExam{{ forloop.counter }}">
                                                                                                Unanswered Questions
                                                                                            </button>
                                                                                        </h2>
                                                                                        <div id="unansweredDetailsExam{{ forloop.counter }}" class="accordion-collapse collapse"
                                                                                            aria-labelledby="unansweredHeadingExam{{ forloop.counter }}" data-bs-parent="#nestedAccordionExam{{ forloop.counter }}">
                                                                                            <div class="accordion-body">
                                                                                                <div class="table-responsive">
                                                                                                    {% if progress.unanswered_questions %}
                                                                                                        <table class="table">
                                                                                                            <thead>
                                                                                                                <tr>
                                                                                                                    <th>Question</th>
                                                                                                                </tr>
                                                                                                            </thead>
                                                                                                            <tbody>
                                                                                                                {% for unanswered in progress.unanswered_questions %}
                                                                                                                    <tr>
                                                                                                                        <td>{{ unanswered.question }}</td>
                                                                                                                    </tr>
                                                                                                                {% endfor %}
                                                                                                            </tbody>
                                                                                                        </table>
                                                                                                    {% else %}
                                                                                                        <div class="text-center">
                                                                                                            <p class="text-muted">No unanswered questions.</p>
                                                                                                        </div>
                                                                                                    {% endif %}
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                            
                                                                                </div> <!-- End of Nested Accordion -->
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div> <!-- End of Expandable Detailed Analysis Section -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <div class="text-center">
                                                <p class="text-muted">No progression report for Exam.</p>
                                            </div>
                                        {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            
                            <div class="modal fade" id="addsubscription">
                                <div class="modal-dialog modal-dialog-centered modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h4 class="modal-title">Admission</h4>
                                            <button type="button" class="btn-close custom-btn-close" data-bs-dismiss="modal" aria-label="Close">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <table class="table table-bordered table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Batch Name</th>
                                                        <th>Start Date</th>
                                                        <th>Expiry Date</th>
                                                        <th>Price</th>
                                                        <th>Late Batch</th>
                                                        <th>Course</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for batch in page_obj %}
                                                    <tr>
                                                        <td>{{ forloop.counter }}</td>
                                                        <td>{{ batch.batch_name }}</td>
                                                        <td>{{ batch.start_date }}</td>
                                                        <td>{{ batch.batch_expiry }}</td>
                                                        <td>{{ batch.batch_price }}</td>
                                                        <td>{{ batch.late_batch|yesno:"Yes,No" }}</td>
                                                        <td>{{ batch.course.course_name }}</td>
                                                    </tr>
                                                    {% empty %}
                                                    <tr>
                                                        <td colspan="7" class="text-center">No batches available</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                            
                                            <!-- Pagination Controls -->
                                            <nav>
                                                <ul class="pagination justify-content-center">
                                                    {% if page_obj.has_previous %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page=1">First</a>
                                                    </li>
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                                    </li>
                                                    {% endif %}
                                                    <li class="page-item active">
                                                        <a class="page-link">{{ page_obj.number }}</a>
                                                    </li>
                                                    {% if page_obj.has_next %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                                    </li>
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
                                                    </li>
                                                    {% endif %}
                                                </ul>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            

                        <div class="modal fade" id="login_detail">
                            <div class="modal-dialog modal-dialog-centered  modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h4 class="modal-title">Login Details</h4>
                                        <button type="button" class="btn-close custom-btn-close" data-bs-dismiss="modal"
                                            aria-label="Close">
                                          <i class="bi bi-x"></i>


                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="student-detail-info">
                                            <span class="student-img">
                                                {% if customer.image and customer.image.url %}
                                                    <img src="{{ customer.image.url }}" alt="">
                                                {% else %}
                                                <i class="bi bi-person-circle fs-3 text-dark"></i>
                                                {% endif %}
                                            </span>
                                            

                                            <div class="name-info">
                                                <h6>{{customer.name}}</h6>
                                            </div>
                                        </div>
                                        <div class="table-responsive custom-table no-datatable_length">
                                            <table class="table datanew">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>User Type</th>
                                                        <th>User Name</th>

                                                        <th>Created</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                   
                                                    <tr>
                                                        <td>Student</td>
                                                        <td>{{customer.name}}</td>
                                                        <td>{{customer.created}}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <a href="#" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- admission modal start -->
                        {% include 'dashboard/student/components/admission_modal.html' %}
                        <!-- admission modal end -->
                        
                        <div class="modal fade" id="add_fees_collect">
                            <div class="modal-dialog modal-dialog-centered  modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <div class="d-flex align-items-center">
                                            <h4 class="modal-title">Collect Fees</h4>
                                            <spa class="badge badge-sm bg-primary ms-2">AD124556</span>
                                        </div>
                                        <button type="button" class="btn-close custom-btn-close" data-bs-dismiss="modal"
                                            aria-label="Close">
                                            <i class="ti ti-x"></i>
                                        </button>
                                    </div>
                                    <form
                                        action="https://preskool.dreamstechnologies.com/html/template/collect-fees.html">
                                        <div class="modal-body">
                                            <div class="bg-light-300 p-3 pb-0 rounded mb-4">
                                                <div class="row align-items-center">
                                                    <div class="col-lg-3 col-md-6">
                                                        <div class="d-flex align-items-center mb-3">
                                                            <a href="https://preskool.dreamstechnologies.com/html/template/student-details.html"
                                                                class="avatar avatar-md me-2">
                                                                <img src="https://preskool.dreamstechnologies.com/html/template/assets/img/students/student-01.jpg"
                                                                    alt="img">
                                                            </a>
                                                            <a href="https://preskool.dreamstechnologies.com/html/template/student-details.html"
                                                                class="d-flex flex-column"><span
                                                                    class="text-dark">Janet</span>III,
                                                                A</a>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-6">
                                                        <div class="mb-3">
                                                            <span class="fs-12 mb-1">Total Outstanding</span>
                                                            <p class="text-dark">2000</p>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-6">
                                                        <div class="mb-3">
                                                            <span class="fs-12 mb-1">Last Date</span>
                                                            <p class="text-dark">25 May 2024</p>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-6">
                                                        <div class="mb-3">
                                                            <span class="badge badge-soft-danger"><i
                                                                    class="ti ti-circle-filled me-2"></i>Unpaid</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-lg-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Fees Group</label>
                                                        <select class="select">
                                                            <option>Select</option>
                                                            <option>Class 1 General</option>
                                                            <option>Monthly Fees</option>
                                                            <option>Admission-Fees</option>
                                                            <option>Class 1- I Installment</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Fees Type</label>
                                                        <select class="select">
                                                            <option>Select</option>
                                                            <option>Tuition Fees</option>
                                                            <option>Monthly Fees</option>
                                                            <option>Admission Fees</option>
                                                            <option>Bus Fees</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Amount</label>
                                                        <input type="text" class="form-control"
                                                            placeholder="Enter Amout">
                                                    </div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Collection Date</label>
                                                        <div class="date-pic">
                                                            <input type="text" class="form-control datetimepicker"
                                                                placeholder="Select">
                                                            <span class="cal-icon"><i class="ti ti-calendar"></i></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Payment Type</label>
                                                        <select class="select">
                                                            <option>Select</option>
                                                            <option>Paytm</option>
                                                            <option>Cash On Delivery</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Payment Reference No</label>
                                                        <input type="text" class="form-control"
                                                            placeholder="Enter Payment Reference No">
                                                    </div>
                                                </div>
                                                <div class="col-lg-12">
                                                    <div class="d-flex align-items-center justify-content-between">
                                                        <div class="status-title">
                                                            <h5>Status</h5>
                                                            <p>Change the Status by toggle </p>
                                                        </div>
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox"
                                                                role="switch" id="switch-sm2">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-12">
                                                    <div class="mb-0">
                                                        <label class="form-label">Notes</label>
                                                        <textarea rows="4" class="form-control"
                                                            placeholder="Add Notes"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <a href="#" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</a>
                                            <button type="submit" class="btn btn-primary">Pay Fees</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>

                    <script src="{% static 'dashboard/ci/template/public/assets/js/jquery-3.7.1.min.js' %}"></script>

                    <script>
                        $(document).ready(function() {
                            // Tab navigation
                            $('.nav-tabs a').on('click', function(e) {
                                e.preventDefault();
                                
                                // Remove active class from all tabs and tab contents
                                $('.nav-tabs a').removeClass('active');
                                $('.tab-content').removeClass('active');
                                
                                // Add active class to clicked tab
                                $(this).addClass('active');
                                
                                // Show corresponding tab content
                                var target = $(this).data('target');
                                $('#' + target).addClass('active');
                            });
                            
                            // Payment plan form functionality
                            const paymentPlanTypeRadios = document.querySelectorAll('input[name="payment_plan_type"]');
                            const existingPlanSection = document.getElementById('existing-plan-section');
                            const newPlanSection = document.getElementById('new-plan-section');
                            
                            // Fields for installment preview calculation
                            const totalAmountField = document.querySelector('input[name="total_amount"]');
                            const numberOfInstallmentsField = document.querySelector('input[name="number_of_installments"]');
                            const discountField = document.querySelector('input[name="discount"]');
                            const frequencySelect = document.querySelector('select[name="installment_frequency"]');
                            const previewTable = document.getElementById('installment-preview-table');
                            
                            // Toggle between existing and new plan sections
                            if (paymentPlanTypeRadios) {
                                paymentPlanTypeRadios.forEach(radio => {
                                    radio.addEventListener('change', function() {
                                        if (this.value === 'existing') {
                                            existingPlanSection.style.display = 'flex';
                                            newPlanSection.style.display = 'none';
                                        } else {
                                            existingPlanSection.style.display = 'none';
                                            newPlanSection.style.display = 'flex';
                                        }
                                    });
                                });
                            }
                            
                            // Generate installment preview when inputs change
                            function updateInstallmentPreview() {
                                if (!previewTable) return;
                                
                                const totalAmount = parseFloat(totalAmountField.value) || 0;
                                const numberOfInstallments = parseInt(numberOfInstallmentsField.value) || 0;
                                const discount = parseFloat(discountField.value) || 0;
                                const frequency = frequencySelect.value || 'monthly';
                                
                                if (totalAmount > 0 && numberOfInstallments > 0) {
                                    const totalAfterDiscount = totalAmount - discount;
                                    const amountPerInstallment = totalAfterDiscount / numberOfInstallments;
                                    
                                    // Generate preview table rows
                                    let tableHtml = '';
                                    const today = new Date();
                                    
                                    for (let i = 0; i < numberOfInstallments; i++) {
                                        let dueDate = new Date(today);
                                        
                                        if (frequency === 'weekly') {
                                            dueDate.setDate(today.getDate() + (7 * i));
                                        } else if (frequency === 'yearly') {
                                            dueDate.setFullYear(today.getFullYear() + i);
                                        } else { // monthly
                                            dueDate.setMonth(today.getMonth() + i);
                                        }
                                        
                                        const formattedDate = dueDate.toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric'
                                        });
                                        
                                        tableHtml += `
                                        <tr>
                                            <td>${i + 1}</td>
                                            <td>${formattedDate}</td>
                                            <td>${amountPerInstallment.toFixed(2)}</td>
                                        </tr>`;
                                    }
                                    
                                    // Update the table
                                    const tbody = previewTable.querySelector('tbody');
                                    if (tbody) {
                                        tbody.innerHTML = tableHtml;
                                    }
                                } else {
                                    // Reset the table if inputs are invalid
                                    const tbody = previewTable.querySelector('tbody');
                                    if (tbody) {
                                        tbody.innerHTML = `
                                        <tr>
                                            <td colspan="3" class="text-center">Configure the payment plan to see installments</td>
                                        </tr>`;
                                    }
                                }
                            }
                            
                            // Add event listeners to update preview
                            if (totalAmountField && numberOfInstallmentsField && discountField && frequencySelect) {
                                [totalAmountField, numberOfInstallmentsField, discountField, frequencySelect].forEach(field => {
                                    field.addEventListener('input', updateInstallmentPreview);
                                    field.addEventListener('change', updateInstallmentPreview);
                                });
                            }
                            
                            // Initial setup based on default selection
                            const initialSelectedType = document.querySelector('input[name="payment_plan_type"]:checked');
                            if (initialSelectedType) {
                                if (initialSelectedType.value === 'existing') {
                                    if (existingPlanSection) existingPlanSection.style.display = 'flex';
                                    if (newPlanSection) newPlanSection.style.display = 'none';
                                } else {
                                    if (existingPlanSection) existingPlanSection.style.display = 'none';
                                    if (newPlanSection) newPlanSection.style.display = 'flex';
                                }
                            }
                        });
                    </script>

                    <!-- Suspend Student Modal -->
                    <div class="modal fade" id="suspend-modal">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-body text-center">
                                    <span class="suspend-icon mb-3 d-block">
                                        <i class="bi bi-person-lock fs-1 text-warning"></i>
                                    </span>
                                    <h4>Suspend Student</h4>
                                    <p>Are you sure you want to suspend this student? They will not be able to access the system until unsuspended.</p>
                                    <div class="d-flex justify-content-center mt-4">
                                        <button class="btn btn-light me-3" data-bs-dismiss="modal">Cancel</button>
                                        <button id="suspend-student" data-user-id="{{ customer.id }}" class="btn btn-warning">Yes, Suspend</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Unsuspend Student Modal -->
                    <div class="modal fade" id="unsuspend-modal">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-body text-center">
                                    <span class="suspend-icon mb-3 d-block">
                                        <i class="bi bi-person-check fs-1 text-success"></i>
                                    </span>
                                    <h4>Unsuspend Student</h4>
                                    <p>Are you sure you want to unsuspend this student? This will restore their access to the system.</p>
                                    <div class="d-flex justify-content-center mt-4">
                                        <button class="btn btn-light me-3" data-bs-dismiss="modal">Cancel</button>
                                        <button id="unsuspend-student" data-user-id="{{ customer.id }}" class="btn btn-success">Yes, Unsuspend</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>
    <script>
                        $(document).ready(function() {
                            
                            // Suspend functionality
                            $('#suspend-student').click(function () {
                                var userId = $(this).data('user-id');
                                
                                console.log("Suspending User ID: " + userId);
                                
                                $.ajax({
                                    url: '/customer/suspend/' + userId + '/',
                                    type: 'POST',
                                    data: {
                                        csrfmiddlewaretoken: '{{ csrf_token }}',
                                    },
                                    success: function (data) {
                                        console.log("Suspended successfully");
                                        window.location.reload();
                                    },
                                    error: function(xhr, status, error) {
                                        console.error("Error suspending user:", error);
                                    }
                                });
                            });
                            
                            // Unsuspend functionality
                            $('#unsuspend-student').click(function () {
                                var userId = $(this).data('user-id');
                                
                                console.log("Unsuspending User ID: " + userId);
                                
                                $.ajax({
                                    url: '/customer/unsuspend/' + userId + '/',
                                    type: 'POST',
                                    data: {
                                        csrfmiddlewaretoken: '{{ csrf_token }}',
                                    },
                                    success: function (data) {
                                        console.log("Unsuspended successfully");
                                        window.location.reload();
                                    },
                                    error: function(xhr, status, error) {
                                        console.error("Error unsuspending user:", error);
                                    }
                                });
                            });
                        });
                    </script>

{% endblock %}

